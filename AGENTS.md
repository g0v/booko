# AGENTS.md — Project Intelligence for TWb00ks

## Project Overview

**民主富二代補課小站** — a curated educational site for Taiwan's democratic history, featuring tiered book lists, documentaries, and community contributions. Deployed to [booko.g0v.tw](https://booko.g0v.tw).

**Tech stack:** React 19 + TypeScript, Vite, Tailwind CSS (CDN), React Router DOM (HashRouter), Lucide React icons, Biome linter/formatter, Husky + lint-staged pre-commit hooks.

## Architecture & Data Flow

```
Google Sheets (SSOT)
  ↓ npm run sync
books_data.ts (auto-generated, git-ignored)
  ↓ imported by
constants.tsx (typed re-exports: BOOKS, CHILDREN_BOOKS, DOCUMENTARIES)
  ↓ consumed by
App.tsx views → components/
```

**Never edit `books_data.ts` directly** — it is regenerated by `npm run sync`.
**Never import from `books_data.ts` in components** — always go through `constants.tsx`.

## File & Naming Conventions

| Category | Convention | Example |
|---|---|---|
| Components | PascalCase `.tsx` | `BookCard.tsx` |
| Hooks | `use` prefix, camelCase `.ts` | `useTheme.ts` |
| Services | camelCase + `Service` suffix `.ts` | `geminiService.ts` |
| Utilities | camelCase `.ts` | `bookCover.ts` |
| Scripts | kebab-case `.js` (Node ESM) | `sync-data.js` |
| Constants | UPPER_SNAKE_CASE exports | `BOOKS`, `DOCUMENTARIES` |
| Interfaces | PascalCase | `Book`, `BookCardProps` |
| Type aliases | PascalCase | `ReadingLevel`, `Theme` |

Types live in a single `types.ts`. Constants live in a single `constants.tsx`.

## Component Patterns

```tsx
// 1. External imports (alphabetical within package)
import { IconName } from 'lucide-react';
import type React from 'react';
import { useState } from 'react';
// 2. Internal imports
import type { Book } from '../types';
import { getBookCoverUrl } from '../utils/bookCover';

// 3. Props interface (directly above component)
interface MyComponentProps {
  book: Book;
  onTagClick?: (tag: string) => void;  // callbacks prefixed with `on`
}

// 4. Component as React.FC with explicit generic
const MyComponent: React.FC<MyComponentProps> = ({ book, onTagClick }) => {
  // ...
};

// 5. Default export (always)
export default MyComponent;
```

**Key rules:**
- Use `import type` for type-only imports (enforced by Biome).
- Destructure props in the function signature.
- Use `useMemo` for filtered/grouped data, `useCallback` for handlers passed as props.
- All buttons must have explicit `type="button"` (unless it's a form submit).
- All `<label>` elements must have `htmlFor` linking to an input `id`, or use `<span>` if purely decorative.

## Styling Rules

**Color palette:** `stone-*` (neutrals), `rose-*` (primary accent), `amber-*` (children/secondary), `red-*` (advanced level).

**Every themed element must include both light and dark variants:**
```html
className="bg-white dark:bg-stone-800 text-stone-900 dark:text-stone-100"
```

**Responsive grid for cards:**
```html
className="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 xl:grid-cols-6 gap-5"
```

**Typography:** `.serif` class for headings (Noto Serif TC). `font-black` for main headings, `font-bold` for sections.

**Transitions:** always add `transition-colors duration-300` on theme-sensitive wrappers.

**Mobile-first:** base classes target mobile; use `sm:`, `md:`, `lg:`, `xl:` for larger screens.

## Reusable Components & Utilities

Before creating anything new, check if these already cover your need:

| What | Where | Purpose |
|---|---|---|
| `BookCard` | `components/BookCard.tsx` | Renders a book with cover, tags, purchase dropdown, library link |
| `DocCard` | `components/DocCard.tsx` | Renders a documentary with poster, metadata, YouTube search link |
| `Layout` | `components/Layout.tsx` | Page shell: header (nav), main, footer. Wraps all routes |
| `ThemeToggle` | `components/ThemeToggle.tsx` | Light/dark/system cycle button |
| `useTheme` | `hooks/useTheme.ts` | Theme state + persistence (localStorage) + system preference detection |
| `getBookCoverUrl` | `utils/bookCover.ts` | Resolves book cover: local path > books.com.tw sharding > fallback |
| `getGeminiInsight` | `services/geminiService.ts` | Calls Gemini API with a prompt, returns text response |

## Code Quality Standards

### Clean Code & SOLID
- **Single Responsibility:** each component does one thing. Views compose cards; cards don't fetch data.
- **Open/Closed:** add new views by creating a new route + component; don't modify existing views to squeeze in unrelated logic.
- **DRY:** if the same JSX block or logic appears twice, extract it into a component or utility. Check the tables above first.
- **Conciseness:** no dead code, no commented-out blocks, no unused imports (Biome enforces this). No speculative abstractions.

### Accessibility (a11y)
- Use semantic HTML: `<header>`, `<main>`, `<footer>`, `<section>`, `<nav>`.
- Interactive elements need `aria-label` when text is not self-evident.
- Images must have meaningful `alt` text.
- External links: always `target="_blank" rel="noopener noreferrer"`.

### Performance
- `loading="lazy"` on all `<img>` tags.
- `useMemo` for any computed/filtered data derived from constants.
- Avoid inline object/array creation in JSX props where it causes unnecessary re-renders.

## Linting & Formatting

Biome is the single tool for both linting and formatting.

```bash
npm run lint          # check only (CI-friendly)
npm run lint:fix      # check + auto-fix
npm run format        # format only
```

**Config highlights** (`biome.json`):
- 2-space indentation, 120 char line width
- Single quotes (JS), double quotes (JSX attributes)
- Recommended lint rules enabled
- Import organization enabled (auto-sorted)
- Scoped to source files only: `*.ts`, `*.tsx`, `*.js`, `components/`, `hooks/`, `services/`, `utils/`, `scripts/`

Pre-commit hook via Husky + lint-staged runs `biome check --write` on staged files automatically.

## Routing

HashRouter with these routes:

| Path | View | Description |
|---|---|---|
| `/` | `BooksView` | Adult books, grouped by level |
| `/children` | `ChildrenView` | Children & youth books |
| `/documentaries` | `DocumentariesView` | Documentaries, grouped by tag |
| `/share` | `ShareView` | Google Form link for submissions |

To add a new route: add to `App.tsx` Routes + add nav item in `Layout.tsx` `navItems` array.

## Commit & PR Conventions

- Commit message prefixes: `feat:`, `fix:`, `docs:`, `chore:`, `refactor:`, `style:`
- Branch naming: `feat/<name>`, `fix/<name>`
- Main branch: `main` (auto-deploys via GitHub Actions)

## README Maintenance Checklist

**After completing any feature:**
1. Check the **待辦事項 / Todo List** section in `README.md`.
2. If the feature matches an existing `- [ ]` item, mark it `- [x]` and update the description if needed.
3. If the feature is new and noteworthy, add a line to **功能特色 / Features**.

**After adding DX tooling** (linter, formatter, CI, scripts, etc.):
1. Add a concise entry to the **技術棧 / Tech Stack** section if it's a new major tool.
2. Document the relevant `npm run` command in **本地開發 / Development**.
3. Keep it brief — one-liner per tool is enough.

**After any architectural change** (adding, removing, or renaming folders/files/routes):
1. Update the **Architecture & Data Flow** section and file tree in this `AGENTS.md`.
2. Update `README.md` if the change affects project structure descriptions, data flow, or developer setup instructions.
3. Both files must stay in sync — never update one without checking the other.

**After any route change** (adding, removing, or renaming routes):
1. Update the **Routing** table in this `AGENTS.md`.
2. Update `sitemap.xml` (in `public/`) if it exists. If no sitemap exists yet, skip this step.
3. Update the `navItems` array in `Layout.tsx` if the route should appear in navigation.

## Common Scripts

```bash
npm run dev          # start dev server (port 3000)
npm run build        # production build → dist/
npm run sync         # fetch data from Google Sheets + download images
npm run lint         # check code
npm run lint:fix     # auto-fix lint issues
npm run format       # auto-format code
```
